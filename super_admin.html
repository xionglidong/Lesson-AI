<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é‡æ¸¡æ— äºº - æ•°å­—åŒ–æ•™å­¦ç®¡ç†åå°</title>
    <script src="./js/localforage.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f8fafc; --card: #ffffff; --text: #334155; }
        body { font-family: 'PingFang SC', system-ui; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .dashboard { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .col-span-2 { grid-column: span 2; }
        .col-span-4 { grid-column: span 4; }
        h2 { font-size: 16px; margin: 0 0 15px 0; color: #64748b; display: flex; align-items: center; gap: 8px; }
        .stat-num { font-size: 32px; font-weight: 800; color: var(--primary); display: block; margin: 5px 0; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 13px; color: #94a3b8; padding: 12px; border-bottom: 2px solid #f1f5f9; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .btn { padding: 6px 14px; border-radius: 8px; border: none; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s; }
        .btn-edit { background: #eff6ff; color: #2563eb; margin-right: 5px; }
        .btn-del { background: #fef2f2; color: #dc2626; }
        .btn:hover { transform: translateY(-1px); filter: brightness(0.95); }
        .chart-container { position: relative; height: 260px; width: 100%; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="card"><span class="stat-num" id="sCount">0</span><span>å­¦ç”Ÿæ€»æ•°</span></div>
    <div class="card"><span class="stat-num" id="aPoints">0</span><span>å…¨å‘˜å‡åˆ†</span></div>
    <div class="card"><span class="stat-num" id="eCount">0</span><span>ç­”é¢˜æ€»é‡</span></div>
    <div class="card"><span class="stat-num" id="topStudent">-</span><span>ç§¯åˆ†å† å†›</span></div>

    <div class="card col-span-2">
        <h2>ğŸ“Š æˆç»©åˆ†å¸ƒç»Ÿè®¡ (äººæ•°)</h2>
        <div class="chart-container"><canvas id="scoreChart"></canvas></div>
    </div>
    <div class="card col-span-2">
        <h2>ğŸ† ç§¯åˆ†è´¡çŒ®æ’è¡Œ Top 5</h2>
        <div class="chart-container"><canvas id="rankChart"></canvas></div>
    </div>

    <div class="card col-span-4">
        <h2>ğŸ‘¤ å­¦ç”Ÿæ•°æ®ç²¾å‡†ç®¡ç†</h2>
        <table>
            <thead>
                <tr>
                    <th>å­¦å·</th>
                    <th>å§“å</th>
                    <th>å½“å‰ç§¯åˆ†</th>
                    <th>ç´¯è®¡ç­”é¢˜</th>
                    <th>ç®¡ç†æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="userList"></tbody>
        </table>
    </div>
</div>

<script>
    let scoreChart, rankChart;

    async function refreshData() {
        const pointsData = await localforage.getItem('studentPoints') || {};
        const allAnswers = await localforage.getItem('studentAnswers') || [];
        const userListBody = document.getElementById('userList');
        
        const ids = Object.keys(pointsData);
        let studentArr = [];
        let totalP = 0;

        userListBody.innerHTML = '';

        ids.forEach(id => {
            const user = pointsData[id];
            const historyCount = allAnswers.filter(a => a.studentId === id).length;
            totalP += user.points;
            studentArr.push({ id, name: user.name, points: user.points, count: historyCount });

            userListBody.innerHTML += `
                <tr>
                    <td>${id}</td>
                    <td><strong>${user.name}</strong></td>
                    <td style="color:#2563eb; font-weight:bold;">${user.points} åˆ†</td>
                    <td>${historyCount} æ¬¡</td>
                    <td>
                        <button class="btn btn-edit" onclick="manualAdd('${id}', '${user.name}')">è°ƒæ•´åˆ†æ•°</button>
                        <button class="btn btn-del" onclick="remove('${id}', '${user.name}')">åˆ é™¤</button>
                    </td>
                </tr>`;
        });

        // åŸºç¡€çœ‹æ¿æ›´æ–°
        document.getElementById('sCount').innerText = ids.length;
        document.getElementById('eCount').innerText = allAnswers.length;
        document.getElementById('aPoints').innerText = ids.length ? (totalP/ids.length).toFixed(1) : 0;
        
        // æ’åºè·å–å† å†›
        const sortedStudents = [...studentArr].sort((a,b) => b.points - a.points);
        document.getElementById('topStudent').innerText = sortedStudents.length > 0 ? sortedStudents[0].name : '-';

        // æ¸²æŸ“å›¾è¡¨
        renderCharts(studentArr);
    }

    function renderCharts(students) {
        // 1. æˆç»©åˆ†å¸ƒå›¾
        const ctxS = document.getElementById('scoreChart').getContext('2d');
        const scoreGroups = [0, 0, 0, 0]; // 0-50, 51-100, 101-200, 200+
        students.forEach(s => {
            if(s.points <= 50) scoreGroups[0]++;
            else if(s.points <= 100) scoreGroups[1]++;
            else if(s.points <= 200) scoreGroups[2]++;
            else scoreGroups[3]++;
        });

        if(scoreChart) scoreChart.destroy();
        scoreChart = new Chart(ctxS, {
            type: 'bar',
            data: {
                labels: ['0-50åˆ†', '51-100åˆ†', '101-200åˆ†', '200åˆ†ä»¥ä¸Š'],
                datasets: [{ label: 'äººæ•°', data: scoreGroups, backgroundColor: '#60a5fa' }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 2. ç§¯åˆ†æ’è¡Œå›¾
        const ctxR = document.getElementById('rankChart').getContext('2d');
        const top5 = [...students].sort((a,b) => b.points - a.points).slice(0, 5);

        if(rankChart) rankChart.destroy();
        rankChart = new Chart(ctxR, {
            type: 'doughnut',
            data: {
                labels: top5.map(s => s.name),
                datasets: [{
                    data: top5.map(s => s.points),
                    backgroundColor: ['#fbbf24', '#94a3b8', '#d97706', '#34d399', '#818cf8']
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    async function manualAdd(id, name) {
        const val = prompt(`æ‰‹åŠ¨è°ƒæ•´ã€${name}ã€‘çš„ç§¯åˆ† (è¾“å…¥ 20 ä¸ºåŠ åˆ†ï¼Œè¾“å…¥ -10 ä¸ºå‡åˆ†):`, "0");
        if(!val || isNaN(val) || val === "0") return;
        let p = await localforage.getItem('studentPoints');
        p[id].points += parseInt(val);
        await localforage.setItem('studentPoints', p);
        refreshData();
    }

    async function remove(id, name) {
        if(!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ°¸ä¹…åˆ é™¤å­¦ç”Ÿã€${name}ã€‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
        let p = await localforage.getItem('studentPoints');
        delete p[id];
        await localforage.setItem('studentPoints', p);
        let a = await localforage.getItem('studentAnswers');
        await localforage.setItem('studentAnswers', a.filter(i => i.studentId !== id));
        refreshData();
    }

    window.onload = refreshData;
</script>
</body>
</html>
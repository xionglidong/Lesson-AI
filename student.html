<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学生答题题系统 - 野渡无人喊你做题题</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <script src="./js/localforage.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5',
            secondary: '#10B981',
            accent: '#F59E0B',
            dark: '#1F2937',
            sky: {
              50: '#F0F9FF',
              100: '#E0F2FE',
            }
          },
        },
      }
    }
  </script>

  <style>
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .answer-card {
      background-color: #f8fafc;
      border-radius: 12px;
    }

    .option-item {
      transition: all 0.2s ease;
    }

    .option-item:hover {
      background-color: #e2e8f0;
      transform: translateX(4px);
    }

    .question-item {
      transition: all 0.2s ease;
    }

    .question-item:hover {
      transform: translateY(-2px);
    }

    .animate-fadeIn {
      animation: fadeIn 0.5s ease forwards;
    }

    .badge-new {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #ef4444;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
    }

    .result-correct {
      background-color: #e6ffed;
      color: #10b981;
      border-left: 3px solid #10b981;
    }

    .result-incorrect {
      background-color: #fee2e2;
      color: #ef4444;
      border-left: 3px solid #ef4444;
    }
  </style>
</head>

<body class="font-sans bg-sky-50 min-h-screen">
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-pencil-square-o text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-primary">野渡无人喊你做题</h1>
      </div>

      <nav class="hidden md:flex items-center space-x-6">
        <a href="index.html" class="text-gray-600 hover:text-primary">首页</a>
        <a href="#" id="logout-btn" class="text-gray-600 hover:text-red-500 hidden"><i
            class="fa fa-sign-out mr-1"></i>退出</a>
      </nav>

      <button class="md:hidden p-2" id="mobile-menu-btn">
        <i class="fa fa-bars text-gray-600"></i>
      </button>
    </div>

    <div id="mobile-menu" class="hidden bg-white border-t md:hidden">
      <div class="container mx-auto px-4 py-2 flex flex-col space-y-3">
        <a href="index.html" class="py-2 text-gray-600">首页</a>
        <a href="#" id="mobile-logout-btn" class="py-2 text-red-500 hidden"><i class="fa fa-sign-out mr-1"></i>退出登录</a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="text-center mb-10">
      <h2 class="text-3xl font-bold mb-4">学生答题入口</h2>
      <p class="text-gray-600">请填写个人信息并查看积分相关信息</p>
    </div>

    <div id="login-card" class="bg-white rounded-xl shadow-md p-6 mb-8">
      <div class="grid md:grid-cols-3 gap-4 items-end">
        <div>
          <label class="block text-gray-700 mb-2">姓名</label>
          <input type="text" id="student-name"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
            placeholder="请输入姓名">
        </div>
        <div>
          <label class="block text-gray-700 mb-2">学号</label>
          <input type="text" id="student-id"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
            placeholder="请输入学号">
        </div>
        <div>
          <button id="login-btn"
            class="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-primary/90 transition-all w-full">
            登录 <i class="fa fa-sign-in ml-1"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="user-points-card" class="bg-white rounded-xl shadow-md p-6 mb-8 hidden">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-xl font-bold flex items-center">
            <i class="fa fa-user-circle text-primary mr-2"></i>
            <span id="user-name-display">张三</span>
            <span class="text-sm text-gray-500 ml-2" id="user-id-display">学号: 2023001</span>
          </h3>
          <p class="text-gray-600 mt-1">当前排名: <span id="user-rank">第5名</span></p>
        </div>
        <div class="text-right">
          <p class="text-3xl font-bold text-accent" id="user-points">800分</p>
        </div>
      </div>
      <div class="mt-4 pt-4 border-t">
        <div class="flex items-center">
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div id="points-progress" class="bg-accent h-2.5 rounded-full" style="width: 80%"></div>
          </div>
          <span class="ml-3 text-sm text-gray-500">距离下一级: 200分</span>
        </div>
      </div>
    </div>

    <div id="stats-dashboard" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8 hidden fade-in">
      <div
        class="bg-white rounded-xl shadow-md p-4 flex items-center justify-between transition-transform hover:scale-105 duration-200">
        <div>
          <p class="text-sm text-gray-500 font-medium">已做套卷</p>
          <p class="text-3xl font-bold text-gray-800 mt-1" id="stat-papers">0</p>
        </div>
        <div
          class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-500 text-xl shadow-sm">
          <i class="fa fa-book"></i>
        </div>
      </div>
      <div
        class="bg-white rounded-xl shadow-md p-4 flex items-center justify-between transition-transform hover:scale-105 duration-200">
        <div>
          <p class="text-sm text-gray-500 font-medium">做题总数</p>
          <p class="text-3xl font-bold text-indigo-600 mt-1" id="stat-total-questions">0</p>
        </div>
        <div
          class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-500 text-xl shadow-sm">
          <i class="fa fa-pencil"></i>
        </div>
      </div>
      <div
        class="bg-white rounded-xl shadow-md p-4 flex items-center justify-between transition-transform hover:scale-105 duration-200">
        <div>
          <p class="text-sm text-gray-500 font-medium">累计错题</p>
          <p class="text-3xl font-bold text-red-500 mt-1" id="stat-wrong-questions">0</p>
        </div>
        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-500 text-xl shadow-sm">
          <i class="fa fa-times-circle"></i>
        </div>
      </div>
      <div
        class="bg-white rounded-xl shadow-md p-4 flex items-center justify-between transition-transform hover:scale-105 duration-200">
        <div>
          <p class="text-sm text-gray-500 font-medium">正确率</p>
          <p class="text-3xl font-bold text-green-600 mt-1" id="stat-accuracy">0%</p>
        </div>
        <div
          class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-500 text-xl shadow-sm">
          <i class="fa fa-pie-chart"></i>
        </div>
      </div>
    </div>

    <div id="exam-container" class="hidden">
      <div id="grade1" class="bg-white rounded-xl shadow-md p-6 mb-8 fade-in">
        <h3 class="text-xl font-bold mb-4 flex items-center">
          <i class="fa fa-book text-primary mr-2"></i> 高一年级套卷
          <span id="grade1PaperCount" class="ml-2 text-sm bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">0套</span>
        </h3>
        <div class="space-y-4" id="grade1PaperList">
          <div class="text-center text-gray-500 py-6">加载中...</div>
        </div>
      </div>

      <div id="grade2" class="bg-white rounded-xl shadow-md p-6 mb-8 fade-in">
        <h3 class="text-xl font-bold mb-4 flex items-center">
          <i class="fa fa-book text-primary mr-2"></i> 高二年级套卷
          <span id="grade2PaperCount" class="ml-2 text-sm bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">0套</span>
        </h3>
        <div class="space-y-4" id="grade2PaperList">
          <div class="text-center text-gray-500 py-6">加载中...</div>
        </div>
      </div>

      <div id="grade3" class="bg-white rounded-xl shadow-md p-6 mb-8 fade-in">
        <h3 class="text-xl font-bold mb-4 flex items-center">
          <i class="fa fa-book text-primary mr-2"></i> 高三年级套卷
          <span id="grade3PaperCount" class="ml-2 text-sm bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">0套</span>
        </h3>
        <div class="space-y-4" id="grade3PaperList">
          <div class="text-center text-gray-500 py-6">加载中...</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
      <h3 class="text-xl font-bold mb-4 flex items-center">
        <i class="fa fa-trophy text-accent mr-2"></i> 积分排行榜
      </h3>
      <div class="grid md:grid-cols-2 gap-3" id="ranking-list">
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold flex items-center">
          <i class="fa fa-gift text-primary mr-2"></i> 积分兑换奖品
        </h3>
        <button id="edit-prizes-btn" class="text-sm bg-primary/10 text-primary px-3 py-1 rounded-full hidden">
          <i class="fa fa-edit mr-1"></i> 编辑奖品
        </button>
      </div>

      <div class="grid md:grid-cols-3 gap-4" id="prizes-container">
      </div>

      <div id="prize-edit-form" class="mt-6 hidden">
        <h4 class="font-bold mb-3">编辑奖品</h4>
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-gray-700 mb-2">奖品名称</label>
            <input type="text" id="prize-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div>
            <label class="block text-gray-700 mb-2">所需积分</label>
            <input type="number" id="prize-points" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
          <div>
            <label class="block text-gray-700 mb-2">描述</label>
            <input type="text" id="prize-desc" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
          </div>
        </div>
        <div class="mt-4 flex justify-end space-x-3">
          <button id="cancel-edit-prize" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg">取消</button>
          <button id="save-prize" class="px-4 py-2 bg-primary text-white rounded-lg">保存</button>
        </div>
      </div>
    </div>

    <div id="exchange-history" class="bg-white rounded-xl shadow-md p-6 mb-8 hidden">
      <h3 class="text-xl font-bold mb-4 flex items-center">
        <i class="fa fa-history text-primary mr-2"></i> 兑换记录
      </h3>
      <div id="history-list" class="space-y-3">
      </div>
    </div>

    <div id="answerCardModal"
      class="fixed inset-0 bg-black/60 flex items items-center items-center justify-center hidden z-50 backdrop-blur-sm">
      <div style="height: 800px;overflow: scroll;padding: 20px;"
        class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 transform transition-all scale-95 opacity-0"
        id="modalContent">
        <div class="flex justify-between items-start mb-6">
          <h3 class="text-xl font-bold text-gray-800" id="modalPaperTitle">第一一套一套海淀期末考试题</h3>
          <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>

        <div class="mb-6 space-y-3">
          <div class="flex justify-between items-center text-sm font-medium">
            <span class="flex items-center text-primary">
              <i class="fa fa-clock-o mr-2"></i> 耗时: <span id="timerDisplay">00:00</span>
            </span>
            <span id="progressText" class="text-gray-600">0 / 0 题</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-secondary h-2 rounded-full" style="width: 0%"></div>
          </div>
        </div>

        <div class="mb-6 flex items-center">
          <span id="modalPaperInfo" class="bg-blue-100 text-blue-500 px-4 py-2 rounded-full text-sm font-medium">共3题 ·
            每题2分 · 总分6分</span>
        </div>

        <div class="flex flex-wrap gap-2 mb-6" id="questionNav">
        </div>

        <div class="answer-card p-6 mb-4 border border-gray-200" id="questionContent">
          <div class="text-center text-gray-500 py-6">请选择左侧题目开始作答</div>
        </div>

        <div class="flex justify-evenly">
          <button id="prevQuestionBtn"
            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
            上一题
          </button>
          <button id="nextQuestionBtn"
            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
            下一题
          </button>
        </div>

        <!-- 填空题区域 -->
        <div id="fillBlankSection" class="mt-4 mb-4 hidden bg-white rounded-xl border border-gray-200 p-6">
          <!-- 动态生成 -->
        </div>


        <button id="submitAllBtn" style="display: block;margin: 40px auto 0;"
          class="px-8 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled>
          提交所有答案
        </button>
      </div>
    </div>

    <div id="historyDetailModal"
      class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 backdrop-blur-sm">
      <div class="bg-white rounded-xl p-8 max-w-xl w-full mx-4 transform transition-all scale-95 opacity-0"
        id="historyDetailContent">
        <div class="flex justify-between items-start mb-6">
          <h3 class="text-xl font-bold text-gray-800" id="historyModalTitle">历史作答详情</h3>
          <button id="closeHistoryDetailModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>

        <div id="historySummary" class="bg-primary/5 p-4 rounded-lg mb-6">
          <p class="text-lg font-bold text-primary mb-1">得分: <span id="historyScoreDisplay">0/0分</span></p>
          <p class="text-sm text-gray-600">耗时: <span id="historyTimeDisplay">00:00</span> | 提交时间: <span
              id="historySubmitTime"></span></p>
        </div>

        <div class="max-h-96 overflow-y-auto pr-2">
          <h4 class="font-bold text-gray-700 mb-3">题目对错详情与解析：</h4>
          <div id="historyDetailsList" class="space-y-3">
          </div>
        </div>
      </div>
    </div>

    <div id="scoreDetailModal"
      class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 backdrop-blur-sm">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center transform transition-all scale-95 opacity-0"
        id="scoreDetailContent">
        <div class="text-green-500 text-4xl mb-4">
          <i class="fa fa-trophy"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2" id="scoreModalTitle">作答提交成功！</h3>
        <p class="text-3xl font-bold mb-4 text-primary" id="finalScoreDisplay">0分</p>
        <p class="text-gray-600 mb-6" id="scoreMessage">本次答题得分已加入您的总积分！</p>

        <div class="bg-gray-50 p-4 rounded-lg max-h-40 overflow-y-auto mb-6 text-left">
          <h4 class="font-bold mb-2">得分详情：</h4>
          <div id="scoreDetailList" class="space-y-1 text-sm">
          </div>
        </div>

        <button id="closeScoreDetailModalBtn"
          class="px-8 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
          确定
        </button>
      </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 transform transition-all scale-95 opacity-0"
        id="modal-general-content">
        <div class="text-center">
          <div id="modal-icon"
            class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa fa-check text-secondary text-2xl"></i>
          </div>
          <h3 id="modal-title" class="text-xl font-bold mb-2">兑换成功</h3>
          <p id="modal-message" class="text-gray-600 mb-6">您已成功兑换学习资料包，积分已扣除500分</p>
          <button id="modal-close" class="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-primary/90">
            确定
          </button>
        </div>
      </div>
    </div>

    <div id="new-paper-modal"
      class="fixed bottom-6 right-6 bg-white rounded-lg shadow-lg p-4 z-40 hidden animate-fadeIn">
      <div class="flex items-center">
        <i class="fa fa-bell text-accent text-xl mr-2"></i>
        <p class="text-gray-700 mr-4">有新的套卷发布啦！</p>
        <button id="refresh-papers-btn" class="text-primary font-medium">立即查看</button>
      </div>
    </div>

    <!-- 视频播放弹窗 -->
    <div id="videoPlayerModal"
      class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-[60] backdrop-blur-sm">
      <div
        class="bg-black rounded-xl p-2 max-w-4xl w-full mx-4 shadow-2xl transform transition-all scale-95 opacity-0 relative"
        id="videoPlayerContent">
        <button id="closeVideoPlayerBtn"
          class="absolute -top-10 right-0 text-white hover:text-gray-300 transition-colors z-50">
          <i class="fa fa-times text-2xl"></i>
        </button>
        <div class="aspect-w-16 aspect-h-9 bg-black rounded-lg overflow-hidden">
          <video id="explanationVideo" controls class="w-full h-full object-contain">
            <source src="" type="video/mp4">
            您的浏览器不支持 HTML5 视频。
          </video>
        </div>
        <div class="mt-2 text-white px-2">
          <h4 id="videoTitle" class="text-lg font-medium">题目讲解</h4>
        </div>
      </div>
    </div>

    <!-- 退出总结弹窗 -->
    <div id="logoutSummaryModal"
      class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 backdrop-blur-sm">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center transform transition-all scale-95 opacity-0"
        id="logoutSummaryContent">
        <div class="text-primary text-4xl mb-4">
          <i class="fa fa-star"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-4">今日学习成果</h3>
        <div class="bg-blue-50 p-4 rounded-lg mb-6">
          <p class="text-gray-700 leading-relaxed" id="logoutSummaryText">
            正在计算今日数据...
          </p>
        </div>
        <div class="flex justify-center space-x-4">
          <button id="cancelLogoutBtn"
            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
            取消
          </button>
          <button id="confirmLogoutBtn"
            class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
            退出
          </button>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-dark text-white py-8 mt-10">
    <div class="container mx-auto px-4 text-center">
      <p>© 2025 野渡无人喊你做题 | 版权所有</p>
    </div>
  </footer>

  <script>
    // 移动端菜单
    document.getElementById('mobile-menu-btn').addEventListener('click', function () {
      document.getElementById('mobile-menu').classList.toggle('hidden');
    });

    // --- 数据存取工具函数 ---

    // 使用 LocalForage 异步获取数据
    async function getData(key) {
      return await localforage.getItem(key);
    }

    // 使用 LocalForage 异步保存数据
    async function saveData(key, value) {
      await localforage.setItem(key, value);
    }

    // 全局变量 - 登录和积分相关
    let userPoints = 0;
    let userName = '';
    let userId = '';
    let userGrade = ''; // 新增：用户年级
    let userRank = 0;

    // 积分等级规则
    const RANK_SYSTEM = [
      { name: '坚韧黑铁', threshold: 0 },
      { name: '英勇黄铜', threshold: 10 },
      { name: '不屈白银', threshold: 50 },
      { name: '荣耀黄金', threshold: 200 },
      { name: '华贵铂金', threshold: 500 },
      { name: '璀璨钻石', threshold: 800 },
      { name: '至尊星耀', threshold: 1200 },
      { name: '超凡大师', threshold: 1500 },
      { name: '傲世宗师', threshold: 1800 },
      { name: '最强王者', threshold: 2000 },
      { name: '非凡王者', threshold: 2500 },
      { name: '无双王者', threshold: 3000 },
      { name: '绝世王者', threshold: 3500 },
      { name: '至圣王者', threshold: 4000 },
      { name: '荣耀王者', threshold: 4500 },
      { name: '传奇王者', threshold: 5000 }
    ];

    // 全局变量 - 答题相关
    const PAPER_STORAGE_KEY = 'gradePapers';
    const ANSWER_STORAGE_KEY = 'studentAnswers';
    const STUDENT_INFO_KEY = 'studentInfo';
    const STUDENT_POINTS_KEY = 'studentPoints';
    const EXCHANGE_RECORDS_KEY = 'exchangeRecords';
    const PRIZES_STORAGE_KEY = 'exchangePrizes';
    let currentPaper = null;
    let currentQuestionIndex = 0;
    let studentAnswers = [];
    let studentInfo = {};
    let studentPointsData = {}; // 异步加载
    let exchangeRecords = []; // 异步加载
    let prizes = []; // 异步加载

    // --- 计时器变量 ---
    let timerInterval = null;
    let secondsElapsed = 0;

    // 填空题相关变量
    let uploadedFbImage = null;
    let fbSelfScore = 0;
    let fbIsConfirmed = false; // 填空题是否已确认

    // DOM元素 - 登录相关
    const loginBtn = document.getElementById('login-btn');
    const studentNameInput = document.getElementById('student-name');
    const studentIdInput = document.getElementById('student-id');
    const userPointsCard = document.getElementById('user-points-card');
    const exchangeHistory = document.getElementById('exchange-history');
    const examContainer = document.getElementById('exam-container');
    const rankingList = document.getElementById('ranking-list');
    const historyList = document.getElementById('history-list');
    const noExchangeHint = document.createElement('div');
    noExchangeHint.className = 'text-center text-gray-500 py-6';
    noExchangeHint.innerHTML = '<i class="fa fa-inbox text-3xl mb-2"></i><p>暂无兑换记录</p>';

    // 奖品编辑相关元素
    const editPrizesBtn = document.getElementById('edit-prizes-btn');
    const prizeEditForm = document.getElementById('prize-edit-form');
    const cancelEditPrize = document.getElementById('cancel-edit-prize');
    const savePrize = document.getElementById('save-prize');
    const prizesContainer = document.getElementById('prizes-container');

    // DOM元素 - 答题相关
    const grade1PaperList = document.getElementById('grade1PaperList');
    const grade2PaperList = document.getElementById('grade2PaperList');
    const grade3PaperList = document.getElementById('grade3PaperList');
    const grade1PaperCount = document.getElementById('grade1PaperCount');
    const grade2PaperCount = document.getElementById('grade2PaperCount');
    const grade3PaperCount = document.getElementById('grade3PaperCount');

    // 弹窗元素 - 答题相关
    const answerCardModal = document.getElementById('answerCardModal');
    const modalContent = document.getElementById('modalContent');
    const modalPaperTitle = document.getElementById('modalPaperTitle');
    const modalPaperInfo = document.getElementById('modalPaperInfo');
    const questionNav = document.getElementById('questionNav');
    const questionContent = document.getElementById('questionContent');
    const prevQuestionBtn = document.getElementById('prevQuestionBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const submitAllBtn = document.getElementById('submitAllBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');

    // *** 计时器和进度条 DOM 元素 ***
    const timerDisplay = document.getElementById('timerDisplay');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    // 得分详情弹窗元素 (提交答案后显示)
    const scoreDetailModal = document.getElementById('scoreDetailModal');
    const scoreDetailContent = document.getElementById('scoreDetailContent');
    const finalScoreDisplay = document.getElementById('finalScoreDisplay');
    const scoreDetailList = document.getElementById('scoreDetailList');
    const scoreMessage = document.getElementById('scoreMessage');
    const closeScoreDetailModalBtn = document.getElementById('closeScoreDetailModalBtn');

    // *** 历史详情弹窗元素 (新增) ***
    const historyDetailModal = document.getElementById('historyDetailModal');
    const historyDetailContent = document.getElementById('historyDetailContent');
    const historyModalTitle = document.getElementById('historyModalTitle');
    const historyScoreDisplay = document.getElementById('historyScoreDisplay');
    const historyTimeDisplay = document.getElementById('historyTimeDisplay');
    const historySubmitTime = document.getElementById('historySubmitTime');
    const historyDetailsList = document.getElementById('historyDetailsList');
    const closeHistoryDetailModalBtn = document.getElementById('closeHistoryDetailModalBtn');

    let allAnswerRecords = []; // 用于缓存所有学生的作答记录
    let fbJudgments = null; // 填空题每题判定结果

    const newPaperModal = document.getElementById('new-paper-modal');
    const refreshPapersBtn = document.getElementById('refresh-papers-btn');

    // 初始化
    async function init() {
      // 首次加载时同步加载必要数据
      studentPointsData = await getData(STUDENT_POINTS_KEY) || {};
      exchangeRecords = await getData(EXCHANGE_RECORDS_KEY) || [];
      prizes = await getData(PRIZES_STORAGE_KEY) || [];

      // 尝试恢复会话
      studentInfo = await getData(STUDENT_INFO_KEY) || {};
      if (studentInfo.name) {
        userName = studentInfo.name;
        userId = studentInfo.id;
        userGrade = studentInfo.grade || '';

        // 自动填充输入框 (可选，增强体验)
        studentNameInput.value = userName;
        studentIdInput.value = userId;

        // 获取最新积分
        if (studentPointsData[userId]) {
          userPoints = studentPointsData[userId].points;
        }

        // 恢复 UI 状态
        document.getElementById('user-name-display').textContent = userName;
        document.getElementById('user-id-display').textContent = `学号: ${userId} 年级：${userGrade || '未设置'}`;
        updateUserPointsDisplay();

        document.getElementById('login-card').classList.add('hidden');
        userPointsCard.classList.remove('hidden');
        exchangeHistory.classList.remove('hidden');
        examContainer.classList.remove('hidden');

        // 加载相关数据
        await calculateUserRank();
        await loadAndRenderPapers();
        await loadExchangeRecords();
        updatePrizeButtons();
      }

      // 绑定登录事件
      loginBtn.addEventListener('click', handleLogin);

      // 绑定退出事件
      document.getElementById('logout-btn').addEventListener('click', handleLogout);
      document.getElementById('mobile-logout-btn').addEventListener('click', handleLogout);

      // 绑定退出总结弹窗事件
      document.getElementById('confirmLogoutBtn').addEventListener('click', performLogout);
      document.getElementById('cancelLogoutBtn').addEventListener('click', closeLogoutSummaryModal);
      const logoutSummaryModal = document.getElementById('logoutSummaryModal');
      logoutSummaryModal.addEventListener('click', e => e.target === logoutSummaryModal && closeLogoutSummaryModal());

      // 绑定奖品兑换事件 (在 renderPrizes 中绑定)

      // 绑定奖品编辑事件
      editPrizesBtn.addEventListener('click', togglePrizeEditForm);
      cancelEditPrize.addEventListener('click', togglePrizeEditForm);
      savePrize.addEventListener('click', savePrizeData);

      // 绑定弹窗事件
      document.getElementById('modal-close').addEventListener('click', closeGeneralModal);
      refreshPapersBtn.addEventListener('click', async function () {
        newPaperModal.classList.add('hidden');
        await loadAndRenderPapers();
      });

      // 绑定答题相关事件
      closeModalBtn.addEventListener('click', closeAnswerModal);
      // answerCardModal.addEventListener('click', e => e.target === answerCardModal && closeAnswerModal());
      prevQuestionBtn.addEventListener('click', goToPrevQuestion);
      nextQuestionBtn.addEventListener('click', goToNextQuestion);
      submitAllBtn.addEventListener('click', submitAllAnswers);
      closeScoreDetailModalBtn.addEventListener('click', closeScoreDetailModal);

      // *** 绑定历史详情弹窗关闭事件 ***
      closeHistoryDetailModalBtn.addEventListener('click', closeHistoryDetailModal);
      historyDetailModal.addEventListener('click', e => e.target === historyDetailModal && closeHistoryDetailModal());

      // 确保所有链接可点击
      document.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', function (e) {
          // 如果是退出按钮，不阻止默认行为（虽然href是#，但在handleLogout里已处理）
          // 这里主要是为了兼容其他页面跳转链接
          if (this.id === 'logout-btn' || this.id === 'mobile-logout-btn') {
            e.preventDefault();
            return;
          }
          if (this.getAttribute('href') && this.getAttribute('href') !== '#') {
            // let default behavior happen for real links
          }
        });
      });

      // 监听异步数据加载（取代原有的 localStorage 监听）
      await initPrizes();
      await loadRankingList();

      // 更新退出按钮状态
      updateLogoutButtonState();
    }

    // 更新退出按钮显示状态
    function updateLogoutButtonState() {
      const logoutBtn = document.getElementById('logout-btn');
      const mobileLogoutBtn = document.getElementById('mobile-logout-btn');

      if (userName) {
        logoutBtn.classList.remove('hidden');
        mobileLogoutBtn.classList.remove('hidden');
      } else {
        logoutBtn.classList.add('hidden');
        mobileLogoutBtn.classList.add('hidden');
      }
    }

    // 显示退出总结弹窗
    async function handleLogout() {
      if (!userName) return;

      const modal = document.getElementById('logoutSummaryModal');
      const content = document.getElementById('logoutSummaryContent');
      const summaryText = document.getElementById('logoutSummaryText');

      // 1. 获取今日数据
      const today = new Date().toLocaleDateString();
      const allAnswers = await getData(ANSWER_STORAGE_KEY) || [];
      const papers = await getData(PAPER_STORAGE_KEY) || [];

      // 筛选今日该学生的作答记录
      const todayRecords = allAnswers.filter(record => {
        if (record.studentId !== userId) return false;
        // 假设 record.submitTime 是 "YYYY-MM-DD HH:mm:ss" 格式
        const recordDate = new Date(record.submitTime.replace(/-/g, '/')).toLocaleDateString();
        return recordDate === today;
      });

      // 2. 计算统计数据 (今日)
      const paperCount = todayRecords.length;
      let todayTotalQuestions = 0;
      let totalCorrect = 0;
      let totalPointsEarned = 0;

      for (const record of todayRecords) {
        totalPointsEarned += (record.score || 0);
        const paper = papers.find(p => p.id === record.paperId);
        if (paper) {
          todayTotalQuestions += paper.questionCount;
          // 填空题
          if (paper.fillInBlankCount > 0) {
            todayTotalQuestions += parseInt(paper.fillInBlankCount);
          }
          // 计算选择题正确数
          if (record.answers && paper.answers) {
            record.answers.forEach((ans, idx) => {
              if (ans === paper.answers[idx]) totalCorrect++;
            });
          }
          // 计算填空题正确数
          if (record.fillInBlankDetails && Array.isArray(record.fillInBlankDetails)) {
            const fbCorrect = record.fillInBlankDetails.filter(Boolean).length;
            totalCorrect += fbCorrect;
          }
        } else {
          if (record.answers) todayTotalQuestions += record.answers.length;
        }
      }
      const todayAccuracy = todayTotalQuestions > 0 ? Math.round((totalCorrect / todayTotalQuestions) * 100) : 0;

      // 3. 计算生涯统计数据 (用于生成个性化鼓励文案)
      const myAllRecords = allAnswers.filter(r => r.studentId === userId);
      let lifeTimeTotalQuestions = 0;
      let lifeTimeCorrect = 0;

      myAllRecords.forEach(record => {
        const paper = papers.find(p => p.id === record.paperId);
        if (paper) {
          let qCount = paper.questionCount;
          if (paper.fillInBlankCount) qCount += parseInt(paper.fillInBlankCount);
          lifeTimeTotalQuestions += qCount;

          if (record.answers && paper.answers) {
            record.answers.forEach((ans, idx) => {
              if (ans === paper.answers[idx]) lifeTimeCorrect++;
            });
          }
          if (record.fillInBlankDetails && Array.isArray(record.fillInBlankDetails)) {
            lifeTimeCorrect += record.fillInBlankDetails.filter(Boolean).length;
          }
        }
      });
      const lifeTimeAccuracy = lifeTimeTotalQuestions > 0 ? Math.round((lifeTimeCorrect / lifeTimeTotalQuestions) * 100) : 0;

      // 生成个性化文案
      let motivationalText = "继续加油！";
      if (lifeTimeTotalQuestions === 0) {
        motivationalText = "千里之行始于足下，期待你明天的进步！";
      } else if (lifeTimeTotalQuestions < 50) {
        if (lifeTimeAccuracy < 60) motivationalText = "万事开头难，别灰心，坚持练习一定会有收获！";
        else if (lifeTimeAccuracy < 85) motivationalText = "不错的开始！保持这个节奏，继续挑战自我！";
        else motivationalText = "开局完美！天赋异禀的你，未来可期！";
      } else if (lifeTimeTotalQuestions < 200) {
        if (lifeTimeAccuracy < 60) motivationalText = "做题量上来了，建议多花点时间复盘错题，质量比数量更重要哦！";
        else if (lifeTimeAccuracy < 85) motivationalText = "稳扎稳打，你的努力正在转化为实力的提升！";
        else motivationalText = "状态火热！保持高正确率，你就是明日之星！";
      } else {
        if (lifeTimeAccuracy < 60) motivationalText = "勤奋的你刷了很多题，试着慢下来复盘一下错题，磨刀不误砍柴工！";
        else if (lifeTimeAccuracy < 85) motivationalText = "你是练习场上的常客了，保持现在的状态，坚持就是胜利！";
        else motivationalText = "独孤求败！如此高的正确率和刷题量，你就是传说中的学霸！";
      }

      // 4. 生成最终 HTML
      summaryText.innerHTML = `
        <span class="font-bold text-lg text-primary">${userName}</span> 同学，<br>
        今日完成 <span class="font-bold text-accent">${paperCount}</span> 套试卷，
        总共 <span class="font-bold text-accent">${todayTotalQuestions}</span> 道题目，<br>
        正确率为 <span class="font-bold text-green-600">${todayAccuracy}%</span>，
        获得了 <span class="font-bold text-accent">${totalPointsEarned}</span> 积分。<br>
        <div class="mt-4 text-gray-500 text-sm border-t pt-3">
            <i class="fa fa-quote-left text-gray-300 mr-2"></i>
            ${motivationalText}
            <i class="fa fa-quote-right text-gray-300 ml-2"></i>
        </div>
      `;

      // 4. 显示弹窗
      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    // 执行实际退出操作
    async function performLogout() {
      // 隐藏总结弹窗
      const modal = document.getElementById('logoutSummaryModal');
      modal.classList.add('hidden');

      // 清除当前会话数据
      userName = '';
      userId = '';
      userPoints = 0;
      userGrade = '';
      studentInfo = {};

      // 清除本地存储的会话信息
      await saveData(STUDENT_INFO_KEY, {});

      // 重置界面
      studentNameInput.value = '';
      studentIdInput.value = '';

      // 显示登录卡片，隐藏用户信息
      document.getElementById('login-card').classList.remove('hidden');
      userPointsCard.classList.add('hidden');
      exchangeHistory.classList.add('hidden');
      examContainer.classList.add('hidden'); // 隐藏答题区域

      // 更新按钮状态
      updateLogoutButtonState();

      // 重置其他 UI 元素
      if (editPrizesBtn) editPrizesBtn.classList.add('hidden');

      showGeneralModal('已退出', '您已成功退出登录', 'success');
    }

    // 关闭退出总结弹窗
    function closeLogoutSummaryModal() {
      const modal = document.getElementById('logoutSummaryModal');
      const content = document.getElementById('logoutSummaryContent');

      content.classList.remove('scale-100', 'opacity-100');
      content.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }

    // --- 计时器控制函数 ---

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      secondsElapsed = 0; // 重置计时
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        secondsElapsed++;
        updateTimerDisplay();
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function updateTimerDisplay() {
      const minutes = String(Math.floor(secondsElapsed / 60)).padStart(2, '0');
      const seconds = String(secondsElapsed % 60).padStart(2, '0');
      timerDisplay.textContent = `${minutes}:${seconds}`;
    }

    // 初始化奖品数据
    async function initPrizes() {
      let currentPrizes = await getData(PRIZES_STORAGE_KEY);
      if (!currentPrizes || currentPrizes.length === 0) {
        // 初始奖品数据
        prizes = [
          {
            id: 'p1',
            name: '学习资料包',
            points: 500,
            description: '精选编程学习资料',
            icon: 'fa-book',
            iconColor: 'text-primary',
            bgColor: 'bg-blue-100'
          },
          {
            id: 'p2',
            name: '咖啡券',
            points: 1000,
            description: '星巴克中杯咖啡',
            icon: 'fa-coffee',
            iconColor: 'text-secondary',
            bgColor: 'bg-green-100'
          },
          {
            id: 'p3',
            name: '耳机',
            points: 3000,
            description: '无线蓝牙耳机',
            icon: 'fa-headphones',
            iconColor: 'text-purple-500',
            bgColor: 'bg-purple-100'
          }
        ];
        await saveData(PRIZES_STORAGE_KEY, prizes);
      } else {
        prizes = currentPrizes;
      }
      renderPrizes();
    }

    // 渲染奖品列表
    function renderPrizes() {
      prizesContainer.innerHTML = '';
      prizes.forEach(prize => {
        const prizeCard = document.createElement('div');
        prizeCard.className = 'border rounded-lg p-4 text-center hover:shadow-md transition-shadow prize-card';
        prizeCard.dataset.points = prize.points;
        prizeCard.dataset.id = prize.id;

        prizeCard.innerHTML = `
          <div class="w-16 h-16 ${prize.bgColor} rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="fa ${prize.icon} ${prize.iconColor} text-2xl"></i>
          </div>
          <h4 class="font-medium mb-1">${prize.name}</h4>
          <p class="text-sm text-gray-500 mb-2">${prize.description}</p>
          <p class="text-accent font-bold">${prize.points}分</p>
          <button class="mt-2 text-sm bg-gray-200 text-gray-500 px-3 py-1 rounded-full prize-btn" data-prize="${prize.name}">积分不足</button>
        `;

        prizesContainer.appendChild(prizeCard);
      });

      // 重新绑定兑换事件
      document.querySelectorAll('.prize-btn').forEach(btn => {
        btn.addEventListener('click', handlePrizeExchange);
      });

      // 如果已登录，更新奖品按钮状态
      if (userName) {
        updatePrizeButtons();
      }
    }

    // 切换奖品编辑表单显示状态
    function togglePrizeEditForm() {
      prizeEditForm.classList.toggle('hidden');
    }

    // 保存奖品数据 (仅在学生端用于测试，实际应由 Admin 端管理)
    async function savePrizeData() {
      const prizeName = document.getElementById('prize-name').value.trim();
      const prizePoints = parseInt(document.getElementById('prize-points').value);
      const prizeDesc = document.getElementById('prize-desc').value.trim();

      if (!prizeName || !prizePoints || !prizeDesc) {
        showGeneralModal('输入错误', '请填写完整的奖品信息', 'warning');
        return;
      }

      // 创建新奖品
      const newPrize = {
        id: 'prize_' + Date.now(),
        name: prizeName,
        points: prizePoints,
        description: prizeDesc,
        icon: 'fa-gift',
        iconColor: 'text-primary',
        bgColor: 'bg-blue-100'
      };

      prizes.push(newPrize);
      await saveData(PRIZES_STORAGE_KEY, prizes);

      // 刷新奖品列表
      renderPrizes();

      // 关闭表单
      togglePrizeEditForm();

      // 清空表单
      document.getElementById('prize-name').value = '';
      document.getElementById('prize-points').value = '';
      document.getElementById('prize-desc').value = '';

      showGeneralModal('成功', '奖品添加成功', 'success');
    }

    // 处理登录
    async function handleLogin() {
      const name = studentNameInput.value.trim();
      const id = studentIdInput.value.trim();

      if (!name || !id) {
        alert('请输入姓名和学号');
        return;
      }

      // 从 IndexedDB 加载学生数据进行校验
      studentPointsData = await getData(STUDENT_POINTS_KEY) || {};

      // *** 严格校验 ***
      if (!studentPointsData[id]) {
        alert('登录失败：该学号不存在。请联系老师添加账号。');
        return;
      }

      if (studentPointsData[id].name !== name) {
        alert('登录失败：姓名与学号不匹配，请检查输入。');
        return;
      }

      // 验证通过
      userName = studentPointsData[id].name; // 使用数据库中的规范姓名
      userId = id;
      userGrade = studentPointsData[id].grade || '';

      // 保存会话信息
      studentInfo = { name: userName, id: userId, grade: userGrade };
      await saveData(STUDENT_INFO_KEY, studentInfo);

      // 获取当前积分
      userPoints = studentPointsData[id].points;

      // 更新用户信息显示
      document.getElementById('user-name-display').textContent = userName;
      document.getElementById('user-id-display').textContent = `学号: ${userId} 年级：${userGrade || '未设置'}`;
      updateUserPointsDisplay();

      // 计算排名
      await calculateUserRank();

      // 隐藏登录卡片，显示用户卡片和兑换记录
      document.getElementById('login-card').classList.add('hidden');
      userPointsCard.classList.remove('hidden');
      exchangeHistory.classList.remove('hidden');

      // 显示答题区域并加载套卷
      examContainer.classList.remove('hidden');      // 重新加载试卷列表以更新状态
      await loadAndRenderPapers();

      // 显示得分详情弹窗更新统计数据
      await renderStudentStats();

      // 显示得分详情弹窗加载兑换记录
      await loadExchangeRecords();

      // 更新奖品按钮状态
      updatePrizeButtons();

      // 首次登录才显示提示
      showGeneralModal('登录成功', `欢迎 ${userName}（学号：${userId}），当前积分：${userPoints}分`, 'success');

      // 更新退出按钮状态
      updateLogoutButtonState();
    }

    // 渲染学生统计数据
    async function renderStudentStats() {
      if (!userId) return;

      const statsDashboard = document.getElementById('stats-dashboard');
      const statPapers = document.getElementById('stat-papers');
      const statTotalQuestions = document.getElementById('stat-total-questions');
      const statWrongQuestions = document.getElementById('stat-wrong-questions');
      const statAccuracy = document.getElementById('stat-accuracy');

      // 确保数据是最新的
      allAnswerRecords = await getData(ANSWER_STORAGE_KEY) || [];
      const papers = await getData(PAPER_STORAGE_KEY) || [];

      // 筛选当前学生记录
      const userRecords = allAnswerRecords.filter(r => r.studentId === userId);

      if (userRecords.length === 0) {
        statsDashboard.classList.remove('hidden');
        statPapers.textContent = '0';
        statTotalQuestions.textContent = '0';
        statWrongQuestions.textContent = '0';
        statAccuracy.textContent = '0%';
        return;
      }

      // 1. 已做套卷数 (去重 paperId)
      const uniquePaperIds = new Set(userRecords.map(r => r.paperId));
      const papersCount = uniquePaperIds.size;

      let totalQuestions = 0;
      let correctQuestions = 0;
      let wrongQuestions = 0;

      // 2. 遍历每一条答题记录计算题目详情
      // 注意：如果有多次提交同一套卷，这里是累计统计每一次做的题？还是只统计最好的一次？
      // 通常"做题总数"是累计练习量，所以这里采用累计所有提交记录的数据。

      userRecords.forEach(record => {
        const paper = papers.find(p => p.id === record.paperId);
        if (!paper) return; // 试卷可能已被删除，跳过

        // 选择题统计
        if (record.answers && paper.answers) {
          record.answers.forEach((ans, index) => {
            // 只有当该题有对应标准答案时才统计
            if (paper.answers[index]) {
              totalQuestions++;
              if (ans === paper.answers[index]) {
                correctQuestions++;
              } else {
                wrongQuestions++;
              }
            }
          });
        }

        // 填空题统计
        if (paper.fillInBlankCount > 0) {
          // 如果有详细判定记录
          if (record.fillInBlankDetails && Array.isArray(record.fillInBlankDetails)) {
            record.fillInBlankDetails.forEach(isCorrect => {
              totalQuestions++;
              if (isCorrect) {
                correctQuestions++;
              } else {
                wrongQuestions++;
              }
            });
          } else {
            // 兼容旧数据：如果没有详细记录，无法精确得知对了哪几题，暂不计入题目数统计，或者根据分数估算？
            // 为保证准确率严谨性，暂忽略无详细判定的旧填空题数据
          }
        }
      });

      // 3. 计算正确率
      let accuracy = 0;
      if (totalQuestions > 0) {
        accuracy = Math.round((correctQuestions / totalQuestions) * 100);
      }

      // 4. 更新 UI
      statPapers.textContent = papersCount;
      statTotalQuestions.textContent = totalQuestions;
      statWrongQuestions.textContent = wrongQuestions;
      statAccuracy.textContent = `${accuracy}%`;

      statsDashboard.classList.remove('hidden');
    }

    // 更新用户积分显示

    function updateUserPointsDisplay() {
      document.getElementById('user-points').textContent = `${userPoints}分`;

      // 计算当前段位
      let currentRankObj = RANK_SYSTEM[0];
      let nextRankObj = null;

      for (let i = 0; i < RANK_SYSTEM.length; i++) {
        if (userPoints >= RANK_SYSTEM[i].threshold) {
          currentRankObj = RANK_SYSTEM[i];
          nextRankObj = RANK_SYSTEM[i + 1] || null;
        } else {
          break;
        }
      }

      // 计算升级进度
      let progress = 0;
      let nextLevelText = '已达最高段位';

      if (nextRankObj) {
        const pointsNeeded = nextRankObj.threshold - currentRankObj.threshold;
        const currentProgress = userPoints - currentRankObj.threshold;
        // 确保分母不为0
        if (pointsNeeded > 0) {
          progress = (currentProgress / pointsNeeded) * 100;
        } else {
          progress = 100;
        }
        nextLevelText = `距离 ${nextRankObj.name}: ${nextRankObj.threshold - userPoints}分`;
      } else {
        progress = 100;
      }

      document.getElementById('points-progress').style.width = `${progress}%`;
      // 修复：确保目标元素选择正确
      const rankInfoElement = document.querySelector('#user-points-card .mt-4.pt-4.border-t .ml-3.text-sm.text-gray-500');
      // Update text content with Rank Name + Distance to next rank
      rankInfoElement.innerHTML = `<span class="font-bold text-secondary mr-2">${currentRankObj.name}</span> <span class="text-xs">${nextLevelText}</span>`;
    }

    // 计算用户排名
    async function calculateUserRank() {
      // 重新从 IndexedDB 加载数据以确保最新
      studentPointsData = await getData(STUDENT_POINTS_KEY) || {};

      // 转换为数组并排序
      const studentsArray = Object.values(studentPointsData);
      studentsArray.sort((a, b) => b.points - a.points);

      // 查找当前用户排名
      const userIndex = studentsArray.findIndex(s => s.id === userId);
      userRank = userIndex + 1;

      // 更新排名显示
      document.getElementById('user-rank').textContent = `第${userRank}名`;
    }

    // 加载排行榜
    async function loadRankingList() {
      rankingList.innerHTML = '';

      // 从 IndexedDB 加载最新数据
      studentPointsData = await getData(STUDENT_POINTS_KEY) || {};

      // 转换为数组并排序
      const studentsArray = Object.values(studentPointsData);
      studentsArray.sort((a, b) => b.points - a.points);

      // 只显示前10名
      const topStudents = studentsArray.slice(0, 10);

      if (topStudents.length === 0) {
        rankingList.innerHTML = '<div class="md:col-span-2 text-center text-gray-500 py-6">暂无排名数据</div>';
        return;
      }

      topStudents.forEach((student, index) => {
        let rankStyle = '';
        if (index === 0) {
          rankStyle = 'bg-yellow-500 text-white';
        } else if (index === 1) {
          rankStyle = 'bg-gray-300 text-gray-700';
        } else if (index === 2) {
          rankStyle = 'bg-orange-600 text-white';
        } else {
          rankStyle = 'bg-gray-200 text-gray-700';
        }

        const rankItem = document.createElement('div');
        rankItem.className = 'flex items-center p-3 border rounded-lg';

        rankItem.innerHTML = `
          <div class="w-8 h-8 rounded-full ${rankStyle} flex items-center justify-center font-bold mr-3">
            ${index + 1}
          </div>
          <div class="flex-1">
            <p class="font-medium">${student.name}</p>
            <p class="text-sm text-gray-500">学号: ${student.id || '未知'}</p>
          </div>
          <div class="text-right">
            <p class="font-bold text-accent">${student.points}分</p>
          </div>
        `;

        rankingList.appendChild(rankItem);
      });
    }

    // 加载兑换记录
    async function loadExchangeRecords() {
      // 从 IndexedDB 加载最新数据
      exchangeRecords = await getData(EXCHANGE_RECORDS_KEY) || [];

      const userRecords = exchangeRecords.filter(record => record.studentId === userId);

      if (userRecords.length === 0) {
        historyList.innerHTML = '';
        historyList.appendChild(noExchangeHint);
        return;
      }

      historyList.innerHTML = '';
      userRecords.forEach(record => {
        const historyItem = document.createElement('div');
        historyItem.className = 'flex items-center justify-between p-3 border rounded-lg bg-gray-50';
        historyItem.innerHTML = `
          <div>
            <p class="font-medium">${record.prizeName}</p>
            <p class="text-sm text-gray-500">${record.time}</p>
          </div>
          <p class="text-accent font-bold">-${record.points}分</p>
        `;

        historyList.appendChild(historyItem);
      });
    }

    // 更新奖品按钮状态
    function updatePrizeButtons() {
      const prizeCards = document.querySelectorAll('.prize-card');

      prizeCards.forEach(card => {
        const requiredPoints = parseInt(card.dataset.points);
        const prizeBtn = card.querySelector('.prize-btn');
        const prizeName = prizeBtn.dataset.prize;

        if (userPoints >= requiredPoints) {
          prizeBtn.classList.remove('bg-gray-200', 'text-gray-500');
          prizeBtn.classList.add('bg-primary/10', 'text-primary');
          prizeBtn.textContent = '兑换';
          prizeBtn.disabled = false;
        } else {
          prizeBtn.classList.remove('bg-primary/10', 'text-primary');
          prizeBtn.classList.add('bg-gray-200', 'text-gray-500');
          prizeBtn.textContent = '积分不足';
          prizeBtn.disabled = true;
        }
      });
    }

    // 奖品兑换处理
    async function handlePrizeExchange() {
      if (!userName) {
        showGeneralModal('请先登录', '请先登录后再进行兑换', 'warning');
        return;
      }

      const prizeBtn = this;
      const prizeName = prizeBtn.dataset.prize;
      const prizeCard = prizeBtn.closest('.prize-card');
      const requiredPoints = parseInt(prizeCard.dataset.points);

      if (userPoints < requiredPoints) {
        showGeneralModal('兑换失败', `您的积分不足，需要${requiredPoints}分`, 'warning');
        return;
      }

      if (!confirm(`确定要兑换${prizeName}吗？将消耗${requiredPoints}积分。`)) {
        return;
      }

      // 记录兑换历史
      const exchangeRecord = {
        id: 'exchange_' + Date.now(),
        studentId: userId,
        studentName: userName,
        prizeName: prizeName,
        points: requiredPoints,
        time: new Date().toLocaleString()
      };

      exchangeRecords.push(exchangeRecord);
      await saveData(EXCHANGE_RECORDS_KEY, exchangeRecords);

      // 更新用户积分
      userPoints -= requiredPoints;
      studentPointsData[userId].points = userPoints;
      studentPointsData[userId].lastUpdate = new Date().toLocaleString();
      await saveData(STUDENT_POINTS_KEY, studentPointsData);

      // 刷新UI
      updateUserPointsDisplay();
      updatePrizeButtons();
      await loadExchangeRecords();
      await calculateUserRank();
      await loadRankingList();

      // 显示成功弹窗
      showGeneralModal('兑换成功', `您已成功兑换${prizeName}，积分已扣除${requiredPoints}分`, 'success');
    }

    // 显示通用弹窗
    function showGeneralModal(title, message, type = 'success') {
      const modal = document.getElementById('modal');
      const modalContent = document.getElementById('modal-general-content');
      const modalTitle = document.getElementById('modal-title');
      const modalMessage = document.getElementById('modal-message');
      const modalIcon = document.getElementById('modal-icon');

      // 设置弹窗类型样式
      if (type === 'success') {
        modalIcon.className = 'w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4';
        modalIcon.innerHTML = '<i class="fa fa-check text-secondary text-2xl"></i>';
      } else if (type === 'warning') {
        modalIcon.className = 'w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4';
        modalIcon.innerHTML = '<i class="fa fa-exclamation-circle text-orange-500 text-2xl"></i>';
      }

      modalTitle.textContent = title;
      modalMessage.textContent = message;

      // 显示弹窗
      modal.classList.remove('hidden');

      // 动画效果
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    // 关闭通用弹窗
    function closeGeneralModal() {
      const modal = document.getElementById('modal');
      const modalContent = document.getElementById('modal-general-content');

      // 动画效果
      modalContent.classList.remove('scale-100', 'opacity-100');
      modalContent.classList.add('scale-95', 'opacity-0');

      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }

    // 加载并渲染套卷列表
    async function loadAndRenderPapers() {
      // 优先读取 LocalForage 中的真实数据（管理员添加的套卷）
      const papers = await getData(PAPER_STORAGE_KEY) || [];

      // 缓存所有学生的作答记录
      allAnswerRecords = await getData(ANSWER_STORAGE_KEY) || [];

      // 兼容旧数据格式
      if (papers.length === 0) {
        // 模拟初始数据（仅在无真实数据时使用）
        const mockPapers = [
          {
            id: 'p1',
            grade: 'grade1',
            name: '高一数学第一单元测试',
            questionCount: 5,
            singlePoints: 2,
            totalPoints: 10,
            options: {
              A: '选项A',
              B: '选项B',
              C: '选项C',
              D: '选项D'
            },
            answers: ['A', 'B', 'C', 'D', 'A'],
            createTime: new Date().toLocaleString()
          },
          {
            id: 'p2',
            grade: 'grade1',
            name: '高一语文月考卷',
            questionCount: 3,
            singlePoints: 3,
            totalPoints: 9,
            options: {
              A: '选项A',
              B: '选项B',
              C: '选项C',
              D: '选项D'
            },
            answers: ['B', 'C', 'A'],
            createTime: new Date().toLocaleString()
          },
          {
            id: 'p3',
            grade: 'grade2',
            name: '高二物理期中测试',
            questionCount: 4,
            singlePoints: 2,
            totalPoints: 8,
            options: {
              A: '选项A',
              B: '选项B',
              C: '选项C',
              D: '选项D'
            },
            answers: ['C', 'D', 'A', 'B'],
            createTime: new Date().toLocaleString()
          }
        ];
        await saveData(PAPER_STORAGE_KEY, mockPapers);
        // 重新加载并渲染
        const reloadedPapers = await getData(PAPER_STORAGE_KEY) || [];
        return processAndRenderPapers(reloadedPapers);
      }

      processAndRenderPapers(papers);
    }

    // 处理和渲染套卷的内部函数
    async function processAndRenderPapers(papers) {
      // 按年级过滤
      const grade1Papers = papers.filter(p => p.grade === 'grade1');
      const grade2Papers = papers.filter(p => p.grade === 'grade2');
      const grade3Papers = papers.filter(p => p.grade === 'grade3');

      // 更新套卷数量
      grade1PaperCount.textContent = `${grade1Papers.length}套`;
      grade2PaperCount.textContent = `${grade2Papers.length}套`;
      grade3PaperCount.textContent = `${grade3Papers.length}套`;

      // 渲染各年级套卷列表
      renderPaperList(grade1PaperList, grade1Papers);
      renderPaperList(grade2PaperList, grade2Papers);
      renderPaperList(grade3PaperList, grade3Papers);

      // *** 核心修改：根据用户年级控制显隐 ***
      const grade1Section = document.getElementById('grade1');
      const grade2Section = document.getElementById('grade2');
      const grade3Section = document.getElementById('grade3');

      // 先全部隐藏 (或者全部显示，取决于默认策略，这里全部隐藏然后按需显示)
      // 如果 userGrade 为空（未登录或未设置），可能显示全部或者都不显示
      // 这里的策略是：如果没有 userGrade，显示全部（兼容旧行为）；如果有，只显示对应年级

      if (!userGrade) {
        grade1Section.classList.remove('hidden');
        grade2Section.classList.remove('hidden');
        grade3Section.classList.remove('hidden');
      } else {
        grade1Section.classList.add('hidden');
        grade2Section.classList.add('hidden');
        grade3Section.classList.add('hidden');

        if (userGrade === '高一') grade1Section.classList.remove('hidden');
        if (userGrade === '高二') grade2Section.classList.remove('hidden');
        if (userGrade === '高三') grade3Section.classList.remove('hidden');
      }

      // 渲染统计数据
      await renderStudentStats();
    }

    /**
     * 检查当前学生是否已经提交过该套题
     * @param {string} paperId 套卷 ID
     * @returns {Promise<object | null>} 返回最新的作答记录，如果没有则返回 null
     */
    async function getLatestAnswerRecord(paperId) {
      const userRecords = allAnswerRecords.filter(a => a.studentId === userId && a.paperId === paperId);

      if (userRecords.length === 0) {
        return null;
      }

      // 找到最新提交的记录 (假设 submitTime 是可比较的字符串或时间戳)
      userRecords.sort((a, b) => new Date(b.submitTime).getTime() - new Date(a.submitTime).getTime());
      return userRecords[0];
    }


    // 渲染套卷列表（添加新套卷标识和详情按钮）
    function renderPaperList(container, papers) {
      if (papers.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-6">暂无套卷</div>';
        return;
      }

      container.innerHTML = '';
      papers.forEach(async (paper, index) => {
        // 判断是否为24小时内新增的套卷
        const isNew = paper.createTime ?
          new Date() - new Date(paper.createTime) < 24 * 60 * 60 * 1000 :
          false;

        // 异步获取最新的作答记录
        const latestRecord = await getLatestAnswerRecord(paper.id);
        const hasAnswered = latestRecord !== null;

        let statusHtml = '';
        let buttonHtml = '';

        if (hasAnswered) {
          statusHtml = `<span class="ml-3 text-sm font-bold ${latestRecord.isFirstSubmission ? 'text-secondary' : 'text-red-500'}">
                ${latestRecord.isFirstSubmission ? '已作答' : '已重做'} · 得分 ${latestRecord.score}/${paper.totalPoints}
            </span>`;
          buttonHtml = `
                <button class="text-primary hover:text-primary/70 text-sm view-history-btn" data-paper-id="${paper.id}">
                    <i class="fa fa-eye mr-1"></i> 查看详情
                </button>`;
        } else {
          statusHtml = `<span class="ml-3 text-sm text-gray-500">点击开始作答</span>`;
          buttonHtml = ``;
        }

        const paperItem = document.createElement('div');
        paperItem.className = 'border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer question-item bg-white relative';
        paperItem.dataset.paperId = paper.id;
        paperItem.innerHTML = `
          <div class="flex flex-col">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-medium text-gray-800">${index + 1}. ${paper.name}</h4>
                <div class="mt-2 flex items-center">
                  <span class="bg-blue-100 text-blue-500 px-3 py-1 rounded-full text-sm font-medium">共${paper.questionCount}题 · 总分${paper.totalPoints}分</span>
                  ${statusHtml}
                </div>
                ${paper.createTime ? `<p class="mt-2 text-xs text-gray-400">发布时间: ${paper.createTime}</p>` : ''}
              </div>
              <div class="flex-shrink-0 mt-1">${buttonHtml}</div>
            </div>
          </div>
          ${isNew ? '<span class="badge-new">新</span>' : ''}
        `;

        // 点击套卷主体打开答题卡
        paperItem.addEventListener('click', function (e) {
          // 确保不是点击了“查看详情”按钮
          if (!e.target.closest('.view-history-btn')) {
            const paperId = this.dataset.paperId;
            openAnswerCard(paperId);
          }
        });

        // *** 绑定查看详情事件 ***
        if (hasAnswered) {
          paperItem.querySelector('.view-history-btn').addEventListener('click', function () {
            showHistoryDetailModal(paper.id);
          });
        }

        container.appendChild(paperItem);
      });
    }

    /**
     * 显示历史作答详情弹窗 (新增功能)
     * @param {string} paperId 套卷 ID
     */
    async function showHistoryDetailModal(paperId) {
      const paper = (await getData(PAPER_STORAGE_KEY)).find(p => p.id === paperId);
      if (!paper) return;

      // 获取该学生对该套题的所有作答记录
      const userRecords = allAnswerRecords.filter(a => a.studentId === userId && a.paperId === paperId);

      if (userRecords.length === 0) {
        alert('未找到您的作答记录。');
        return;
      }

      // 默认显示最新记录
      userRecords.sort((a, b) => new Date(b.submitTime).getTime() - new Date(a.submitTime).getTime());
      const latestRecord = userRecords[0];

      // 填充基本信息
      historyModalTitle.textContent = `${paper.name} - 历史作答详情`;
      historyScoreDisplay.textContent = `${latestRecord.score}/${latestRecord.totalPoints}分`;
      historySubmitTime.textContent = latestRecord.submitTime;

      // 格式化耗时
      const timeElapsed = latestRecord.timeElapsed || 0;
      const minutes = String(Math.floor(timeElapsed / 60)).padStart(2, '0');
      const seconds = String(timeElapsed % 60).padStart(2, '0');
      historyTimeDisplay.textContent = `${minutes}:${seconds}`;

      // 填充详细对错列表
      historyDetailsList.innerHTML = '';

      latestRecord.answers.forEach((ans, i) => {
        const isCorrect = ans === paper.answers[i];

        // 检查是否有视频讲解
        const videoPath = (paper.videos && paper.videos[i]) ? paper.videos[i] : null;
        let videoBtnHtml = '';
        if (videoPath) {
          // 这里假设视频文件都在 video 文件夹下
          const fullVideoPath = `./video/${videoPath}`;
          videoBtnHtml = `
            <button onclick="playExplanationVideo('${fullVideoPath}', '第 ${i + 1} 题讲解')" 
               class="mt-2 text-xs bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full hover:bg-indigo-200 transition-colors flex items-center w-fit">
               <i class="fa fa-play-circle mr-1.5 text-indigo-600"></i> 观看视频讲解
            </button>
          `;
        }

        const detailItem = document.createElement('div');
        detailItem.className = `p-3 rounded-lg ${isCorrect ? 'result-correct' : 'result-incorrect'}`;
        detailItem.innerHTML = `
                <div class="flex justify-between items-start">
                  <div>
                    <p class="font-medium">
                        <span class="mr-2">${i + 1}. 题目 ${i + 1}</span>
                        <span class="text-sm">${isCorrect ? '✅ 回答正确' : '❌ 回答错误'}</span>
                    </p>
                    <div class="mt-1 text-sm space-y-0.5">
                        <p>你的答案: <span class="font-bold">${ans}</span></p>
                        <p>正确答案: <span class="font-bold">${paper.answers[i]}</span></p>
                        <p class="text-xs text-gray-500">
                            ${paper.options[paper.answers[i]] || '无选项内容'}
                        </p>
                    </div>
                  </div>
                </div>
                ${videoBtnHtml}
            `;
        historyDetailsList.appendChild(detailItem);
      });

      // 如果有填空题，显示填空题详情
      if (latestRecord.fillInBlankStudentImage && paper.fillInBlankCount > 0) {

        // 生成填空题视频按钮
        let fbVideosHtml = '';
        if (paper.fillBlankVideos && paper.fillBlankVideos.some(v => v)) {
          fbVideosHtml = '<div class="mt-4 p-3 bg-indigo-50 rounded-lg border border-indigo-100"><h5 class="text-sm font-bold text-indigo-800 mb-2">填空题视频讲解</h5><div class="space-y-2">';
          paper.fillBlankVideos.forEach((video, i) => {
            if (video) {
              const fullVideoPath = `./video/${video}`;
              fbVideosHtml += `
                <div class="flex items-center space-x-2">
                    <span class="text-xs font-medium text-gray-600 w-16">第 ${i + 1} 题:</span>
                    <button onclick="playExplanationVideo('${fullVideoPath}', '第 ${i + 1} 道填空题讲解')" 
                       class="text-xs bg-white border border-indigo-200 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-50 transition-colors flex items-center shadow-sm">
                       <i class="fa fa-play-circle mr-1.5 text-indigo-600"></i> 观看视频
                    </button>
                </div>
              `;
            }
          });
          fbVideosHtml += '</div></div>';
        }

        // 生成填空题每题判定详情
        let judgmentsHtml = '';
        if (latestRecord.fillInBlankDetails && Array.isArray(latestRecord.fillInBlankDetails)) {
          judgmentsHtml = '<div class="mt-4"><h5 class="text-sm font-bold text-gray-600 mb-2">自评详情</h5><div class="grid grid-cols-3 md:grid-cols-5 gap-2">';
          latestRecord.fillInBlankDetails.forEach((isCorrect, idx) => {
            judgmentsHtml += `
              <div class="px-2 py-1.5 rounded border flex items-center justify-center space-x-2 ${isCorrect ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700'}">
                 <span class="text-xs font-medium">题${idx + 1}</span>
                 <i class="fa ${isCorrect ? 'fa-check' : 'fa-times'} text-sm"></i>
              </div>
            `;
          });
          judgmentsHtml += '</div></div>';
        }

        const fbDetailItem = document.createElement('div');
        fbDetailItem.className = 'mt-6 border-t pt-4';
        fbDetailItem.innerHTML = `
                <h4 class="font-bold text-gray-700 mb-3">填空题部分 (自评得分: ${latestRecord.fillInBlankScore}分)</h4>
                <div class="grid md:grid-cols-2 gap-4">
                   <div class="border rounded-lg p-2">
                      <h5 class="text-center font-bold mb-2 text-xs text-gray-500">你的答题卡</h5>
                      <img src="${latestRecord.fillInBlankStudentImage}" class="w-full h-auto rounded object-contain cursor-pointer hover:opacity-90" onclick="showImagePreview(this.src)" />
                   </div>
                   <div class="border rounded-lg p-2 bg-green-50">
                      <h5 class="text-center font-bold mb-2 text-xs text-green-700">参考答案</h5>
                      <img src="${paper.fillInBlankAnswerImage || ''}" class="w-full h-auto rounded object-contain cursor-pointer hover:opacity-90" onclick="showImagePreview(this.src)" />
                   </div>
                </div>
                ${judgmentsHtml}
                ${fbVideosHtml}
            `;
        historyDetailsList.appendChild(fbDetailItem);
      }

      // 显示弹窗
      historyDetailModal.classList.remove('hidden');
      setTimeout(() => {
        historyDetailContent.classList.remove('scale-95', 'opacity-0');
        historyDetailContent.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    // 关闭历史详情弹窗
    function closeHistoryDetailModal() {
      historyDetailContent.classList.remove('scale-100', 'opacity-100');
      historyDetailContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        historyDetailModal.classList.add('hidden');
      }, 300);
    }


    // 打开答题卡 (修改: 点击外部区域不关闭，只能点按钮关闭)
    // answerCardModal.addEventListener('click', e => e.target === answerCardModal && closeAnswerModal());

    // 视频播放功能
    const videoPlayerModal = document.getElementById('videoPlayerModal');
    const videoPlayerContent = document.getElementById('videoPlayerContent');
    const explanationVideo = document.getElementById('explanationVideo');
    const closeVideoPlayerBtn = document.getElementById('closeVideoPlayerBtn');
    const videoTitle = document.getElementById('videoTitle');

    function playExplanationVideo(src, title) {
      explanationVideo.src = src;
      videoTitle.textContent = title;

      videoPlayerModal.classList.remove('hidden');
      setTimeout(() => {
        videoPlayerContent.classList.remove('scale-95', 'opacity-0');
        videoPlayerContent.classList.add('scale-100', 'opacity-100');
        explanationVideo.play().catch(e => console.log('Auto-play blocked:', e));
      }, 10);
    }

    function closeVideoPlayer() {
      explanationVideo.pause();
      videoPlayerContent.classList.remove('scale-100', 'opacity-100');
      videoPlayerContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        videoPlayerModal.classList.add('hidden');
        explanationVideo.src = ''; // Clear source to stop buffering
      }, 300);
    }

    closeVideoPlayerBtn.addEventListener('click', closeVideoPlayer);
    videoPlayerModal.addEventListener('click', e => e.target === videoPlayerModal && closeVideoPlayer());

    // 打开答题卡
    async function openAnswerCard(paperId) {
      if (!userName) {
        showGeneralModal('请先登录', '请先登录后再进行答题', 'warning');
        return;
      }

      const papers = await getData(PAPER_STORAGE_KEY) || [];
      currentPaper = papers.find(p => p.id === paperId);

      if (!currentPaper) return;

      // 检查是否已作答
      const latestRecord = await getLatestAnswerRecord(paperId);
      const hasAnswered = latestRecord !== null;

      if (hasAnswered) {
        showGeneralModal('提示', '该套卷您已完成作答，请查看详情。', 'warning');
        return;
      }

      // *** 优化 1: 启动计时器 ***
      stopTimer(); // 确保旧计时器停止
      startTimer();

      // 初始化答案存储
      studentAnswers = new Array(currentPaper.questionCount).fill(null);
      currentQuestionIndex = 0;

      // 填充弹窗信息
      modalPaperTitle.textContent = currentPaper.name;
      modalPaperInfo.textContent = `选择题共${currentPaper.questionCount}题 · 每题${currentPaper.singlePoints}分 · 总分${currentPaper.totalPoints}分`;

      // 生成题目导航
      generateQuestionNav();

      // 渲染第一题
      renderCurrentQuestion();

      // 更新按钮状态
      updateNavButtons();

      // 额外的提示和提交按钮文本/禁用处理
      if (hasAnswered) {
        submitAllBtn.textContent = '提交 (无积分)';
        // 提交按钮在首次渲染时默认是 disabled，但在答完所有题后会启用，此处无需特殊处理
      } else {
        submitAllBtn.textContent = '提交所有答案';
      }

      // 显示弹窗
      answerCardModal.classList.remove('hidden');
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);

      // 渲染填空题部分
      renderFillBlankSection(hasAnswered);
    }

    // 渲染填空题部分
    function renderFillBlankSection(hasAnswered) {
      const fbSection = document.getElementById('fillBlankSection');
      const count = currentPaper.fillInBlankCount || 0;

      if (count === 0) {
        fbSection.classList.add('hidden');
        return;
      }

      fbSection.classList.remove('hidden');

      // 如果已经作答过，不再允许上传和重新评分，只显示结果 (但在 submitAllAnswers 里会更新 UI)
      // 这里主要处理尚未提交时的 UI

      const totalFbPoints = count * (currentPaper.fillInBlankPoints || 0);

      fbSection.innerHTML = `
        <h4 class="text-lg font-bold mb-4 flex items-center">
            <i class="fa fa-pencil text-primary mr-2"></i> 填空题部分 
            <span class="ml-2 text-sm bg-gray-100 px-2 py-1 rounded text-gray-600">共${count}题 · 总分${totalFbPoints}分</span>
        </h4>
        
        <div id="fbUploadStep" class="text-center p-8 border-2 border-dashed border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            <input type="file" id="fbUploadInput" accept="image/*" class="hidden">
            <div class="cursor-pointer" onclick="document.getElementById('fbUploadInput').click()">
                <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-3"></i>
                <p class="font-medium text-gray-700">点击上传答题卡照片</p>
                <p class="text-sm text-gray-500 mt-1">上传后需确认才能查看参考答案</p>
            </div>
        </div>
        
        <div id="fbGradingStep" class="hidden animate-fadeIn">
            <div class="grid md:grid-cols-2 gap-4">
               <div class="border rounded-lg p-2">
                  <h5 class="text-center font-bold mb-2 text-gray-700">你的答案</h5>
                  <img id="fbStudentImage" class="w-full h-auto rounded object-contain max-h-[300px] cursor-pointer hover:opacity-90" onclick="showImagePreview(this.src)" />
                  
                  <!-- 操作按钮区域 -->
                  <div id="fbActionButtons" class="mt-3 flex justify-center space-x-3">
                      <button onclick="reuploadImage()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-medium">
                        <i class="fa fa-refresh mr-1"></i> 重新上传
                      </button>
                      <button onclick="confirmUpload()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm font-medium">
                        <i class="fa fa-check mr-1"></i> 确认提交
                      </button>
                  </div>
                  <div id="fbConfirmedBadge" class="hidden mt-2 text-center">
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">
                        <i class="fa fa-lock mr-1"></i> 已确认
                    </span>
                  </div>
               </div>
               
               <div id="fbReferenceArea" class="hidden border rounded-lg p-2 bg-green-50">
                  <h5 class="text-center font-bold mb-2 text-green-700">参考答案</h5>
                  <img id="fbTeacherImage" src="${currentPaper.fillInBlankAnswerImage || ''}" class="w-full h-auto rounded object-contain max-h-[300px] cursor-pointer hover:opacity-90" onclick="showImagePreview(this.src)" />
               </div>
            </div>
            
            <div id="fbScoreArea" class="hidden mt-6 bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
               <div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                  <h5 class="font-bold text-gray-800">自评打分</h5>
                  <span id="fbCurrentScoreDisplay" class="text-primary font-bold text-lg">当前得分: 0 / ${totalFbPoints}</span>
               </div>
               <div class="p-4">
                   <p class="text-sm text-gray-500 mb-4 bg-blue-50 text-blue-700 p-2 rounded">
                     <i class="fa fa-info-circle mr-1"></i> 请对照参考答案，为每一道填空题判断对错。系统将自动计算总分。
                   </p>
                   <div id="fbQuestionJudgments" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                       <!-- 动态生成题目判定项 -->
                   </div>
               </div>
            </div>
        </div>
      `;

      // 绑定上传事件
      const uploadInput = document.getElementById('fbUploadInput');
      if (uploadInput) {
        uploadInput.addEventListener('change', async function (e) {
          if (this.files && this.files[0]) {
            try {
              const base64 = await getBase64(this.files[0]);
              uploadedFbImage = base64;
              fbIsConfirmed = false; // 重置确认状态

              // 切换显示
              document.getElementById('fbUploadStep').classList.add('hidden');
              document.getElementById('fbGradingStep').classList.remove('hidden');

              document.getElementById('fbStudentImage').src = base64;

              // 确保操作按钮显示，参考答案隐藏
              document.getElementById('fbActionButtons').classList.remove('hidden');
              document.getElementById('fbConfirmedBadge').classList.add('hidden');
              document.getElementById('fbReferenceArea').classList.add('hidden');
              document.getElementById('fbScoreArea').classList.add('hidden');

              // 更新提交按钮
              const allAnswered = studentAnswers.every(answer => answer !== null);
              submitAllBtn.disabled = !allAnswered || (currentPaper.fillInBlankAnswerImage ? !uploadedFbImage : false);
            } catch (err) {
              console.error(err);
              alert('图片上传失败');
            }
          }
        });
      }

      // 生成题目判定 UI
      const judgmentsContainer = document.getElementById('fbQuestionJudgments');
      fbJudgments = new Array(count).fill(null); // 初始化判定数组 (true/false/null)

      for (let i = 0; i < count; i++) {
        const item = document.createElement('div');
        item.className = 'border rounded p-3';
        item.innerHTML = `
            <div class="font-medium text-gray-700">第 ${i + 1} 题</div>
            <div class="flex space-x-2">
                <button type="button" class="fb-judge-btn p-1 px-3 rounded border border-gray-300 hover:bg-gray-100 text-gray-400 transition-colors" data-index="${i}" data-val="true">
                    <i class="fa fa-check"></i>
                </button>
                <button type="button" class="fb-judge-btn p-1 px-3 rounded border border-gray-300 hover:bg-gray-100 text-gray-400 transition-colors" data-index="${i}" data-val="false">
                    <i class="fa fa-times"></i>
                </button>
            </div>
          `;
        judgmentsContainer.appendChild(item);
      }

      // 绑定判定点击事件
      judgmentsContainer.addEventListener('click', function (e) {
        const btn = e.target.closest('.fb-judge-btn');
        if (!btn) return;

        const index = parseInt(btn.dataset.index);
        const val = btn.dataset.val === 'true'; // string to boolean

        // 更新状态
        fbJudgments[index] = val;

        // 更新 UI 样式
        const parent = btn.parentElement;
        const btns = parent.querySelectorAll('.fb-judge-btn');
        btns.forEach(b => {
          // 重置样式
          b.classList.remove('bg-green-500', 'text-white', 'border-green-500', 'bg-red-500', 'border-red-500');
          b.classList.add('border-gray-300', 'text-gray-400');

          // 如果是当前点击的按钮，应用激活样式
          if (b === btn) {
            b.classList.remove('border-gray-300', 'text-gray-400', 'hover:bg-gray-100');
            if (val) {
              b.classList.add('bg-green-500', 'text-white', 'border-green-500');
            } else {
              b.classList.add('bg-red-500', 'text-white', 'border-red-500');
            }
          }
        });

        // 自动计算分数
        calculateFbScore();
      });

      // 重置变量
      uploadedFbImage = null;
      fbSelfScore = 0;
      fbIsConfirmed = false;
      // fbJudgments 已经在上面初始化了
    }

    // 自动计算填空题分数
    function calculateFbScore() {
      if (!fbJudgments) return;
      const correctCount = fbJudgments.filter(j => j === true).length;
      const pointsPerQuestion = currentPaper.fillInBlankPoints || 0;
      fbSelfScore = correctCount * pointsPerQuestion;

      // 更新显示
      const display = document.getElementById('fbCurrentScoreDisplay');
      const count = currentPaper.fillInBlankCount || 0;
      const total = count * pointsPerQuestion;
      if (display) {
        display.textContent = `当前得分: ${fbSelfScore} / ${total}`;
      }
    }

    // 重新上传图片
    function reuploadImage() {
      document.getElementById('fbUploadInput').click();
    }

    // 确认上传
    function confirmUpload() {
      if (!uploadedFbImage) return;

      if (!confirm('确认提交这张答题卡吗？确认后将显示参考答案且无法再修改图片。')) {
        return;
      }

      fbIsConfirmed = true;

      // 隐藏按钮，显示参考答案和评分
      document.getElementById('fbActionButtons').classList.add('hidden');
      document.getElementById('fbConfirmedBadge').classList.remove('hidden');
      document.getElementById('fbReferenceArea').classList.remove('hidden');
      document.getElementById('fbScoreArea').classList.remove('hidden');
    }

    // 辅助函数：文件转Base64
    function getBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // 生成题目导航
    function generateQuestionNav() {
      questionNav.innerHTML = '';
      for (let i = 0; i < currentPaper.questionCount; i++) {
        const navBtn = document.createElement('button');
        navBtn.className = `w-8 h-8 rounded-full flex items-center justify-center text-sm ${i === 0 ? 'bg-primary text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
        navBtn.textContent = i + 1;
        navBtn.dataset.questionIndex = i;

        navBtn.addEventListener('click', function () {
          currentQuestionIndex = parseInt(this.dataset.questionIndex);
          renderCurrentQuestion();
          updateNavButtons();
          updateQuestionNavStyle();
        });

        questionNav.appendChild(navBtn);
      }
    }

    // 更新题目导航样式
    function updateQuestionNavStyle() {
      const navButtons = questionNav.querySelectorAll('button');
      navButtons.forEach((btn, index) => {
        if (index === currentQuestionIndex) {
          btn.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm bg-primary text-white';
        } else if (studentAnswers[index] !== null) {
          btn.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm bg-green-100 text-green-700';
        } else {
          btn.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm bg-gray-200 text-gray-700 hover:bg-gray-300';
        }
      });
    }

    // 渲染当前题目
    function renderCurrentQuestion() {
      const questionNumber = currentQuestionIndex + 1;

      // 生成题目内容
      questionContent.innerHTML = `
        <div class="mb-4">
          <h4 class="text-lg font-medium">${questionNumber}. 这是第${questionNumber}题，考查相关知识点</h4>
          <p class="text-gray-600 text-sm mt-2">(${currentPaper.singlePoints}分)</p>
        </div>
        <div class="space-y-2 mt-4">
          ${Object.entries(currentPaper.options).map(([key, value]) => `
            <div class="option-item p-3 border rounded-lg cursor-pointer ${studentAnswers[currentQuestionIndex] === key ? 'bg-primary/10 border-primary/30' : ''}" data-option="${key}">
              <div class="flex items-center">
                <div class="w-6 h-6 rounded-full border ${studentAnswers[currentQuestionIndex] === key ? 'bg-primary border-primary text-white' : 'border-gray-300'} flex items-center justify-center mr-3">
                  ${studentAnswers[currentQuestionIndex] === key ? '<i class="fa fa-check text-xs"></i>' : key}
                </div>
                <span>${value}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // 绑定选项点击事件
      questionContent.querySelectorAll('.option-item').forEach(option => {
        option.addEventListener('click', function () {
          const selectedOption = this.dataset.option;
          studentAnswers[currentQuestionIndex] = selectedOption;
          renderCurrentQuestion();
          updateQuestionNavStyle();
          updateNavButtons();
        });
      });

      // *** 优化 1: 更新进度条 ***
      updateProgressBar();
    }

    // *** 新增：更新进度条 ***
    function updateProgressBar() {
      const answeredCount = studentAnswers.filter(a => a !== null).length;
      const totalCount = currentPaper.questionCount;
      const progressPercentage = (answeredCount / totalCount) * 100;

      progressBar.style.width = `${progressPercentage}%`;
      progressText.textContent = `${answeredCount} / ${totalCount} 题`;
    }

    // 更新导航按钮状态
    function updateNavButtons() {
      // 更新上一题按钮
      prevQuestionBtn.disabled = currentQuestionIndex === 0;

      // 更新下一题按钮
      nextQuestionBtn.disabled = currentQuestionIndex === currentPaper.questionCount - 1;

      // 更新提交按钮
      const allAnswered = studentAnswers.every(answer => answer !== null);
      submitAllBtn.disabled = !allAnswered || (currentPaper.fillInBlankAnswerImage ? !uploadedFbImage : false);

      // 更新导航样式
      updateQuestionNavStyle();
    }

    // 上一题
    function goToPrevQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderCurrentQuestion();
        updateNavButtons();
      }
    }

    // 下一题
    function goToNextQuestion() {
      if (currentQuestionIndex < currentPaper.questionCount - 1) {
        currentQuestionIndex++;
        renderCurrentQuestion();
        updateNavButtons();
      }
    }

    // 提交所有答案
    async function submitAllAnswers() {
      // 检查填空题是否已完成
      if (currentPaper.fillInBlankCount > 0) {
        if (!uploadedFbImage) {
          alert('请上传填空题答题卡照片');
          // 滚动到底部
          document.getElementById('fillBlankSection').scrollIntoView({ behavior: 'smooth' });
          return;
        }
        if (!fbIsConfirmed) {
          alert('请先确认您的填空题答题卡，以便显示参考答案进行自评');
          document.getElementById('fillBlankSection').scrollIntoView({ behavior: 'smooth' });
          return;
        }
        if (!fbIsConfirmed) {
          alert('请先确认您的填空题答题卡，以便显示参考答案进行自评');
          document.getElementById('fillBlankSection').scrollIntoView({ behavior: 'smooth' });
          return;
        }
        if (!fbIsConfirmed) {
          alert('请先确认您的填空题答题卡，以便显示参考答案进行自评');
          document.getElementById('fillBlankSection').scrollIntoView({ behavior: 'smooth' });
          return;
        }

        // 检查是否所有题目都已判定
        if (!fbJudgments || fbJudgments.includes(null)) {
          alert('请为每一道填空题判断对错 (点击“对”或“错”)');
          document.getElementById('fillBlankSection').scrollIntoView({ behavior: 'smooth' });
          return;
        }
      }

      if (!confirm(`确定要提交所有答案吗？提交后将无法修改。`)) {
        return;
      }

      // *** 优化 1: 停止计时器 ***
      stopTimer();

      // 检查是否已作答，决定是否增加积分
      const latestRecord = await getLatestAnswerRecord(currentPaper.id);
      const isFirstSubmission = latestRecord === null;

      // 计算得分和详情 (计算过程不变)
      let score = 0;
      const scoreDetails = [];
      studentAnswers.forEach((answer, index) => {
        const isCorrect = answer === currentPaper.answers[index];
        if (isCorrect) {
          score += currentPaper.singlePoints;
        }
        scoreDetails.push({
          questionNumber: index + 1,
          isCorrect: isCorrect,
          correctAnswer: currentPaper.answers[index],
          yourAnswer: answer
        });
      });

      // *** 修正: 加上填空题得分 ***
      score += (fbSelfScore || 0);

      // 获取最新的答题记录
      let allAnswers = await getData(ANSWER_STORAGE_KEY) || [];

      // 保存答题记录 (记录总是保存)
      const answerRecord = {
        paperId: currentPaper.id,
        studentId: userId,
        studentName: userName,
        answers: studentAnswers,
        score: score,
        totalPoints: currentPaper.totalPoints,
        submitTime: new Date().toLocaleString(),
        timeElapsed: secondsElapsed, // 记录耗时
        isFirstSubmission: isFirstSubmission, // 标记是否为首次提交
        // 填空题数据
        fillInBlankStudentImage: uploadedFbImage,
        fillInBlankScore: fbSelfScore || 0,
        fillInBlankDetails: fbJudgments // 保存详细判定结果
      };

      allAnswers.push(answerRecord);
      await saveData(ANSWER_STORAGE_KEY, allAnswers);
      allAnswerRecords = allAnswers; // 更新缓存


      let message = '';
      if (isFirstSubmission) {
        // 只有首次提交才增加积分
        // 确保学生积分数据是最新的
        studentPointsData = await getData(STUDENT_POINTS_KEY) || {};
        studentPointsData[userId].points += score;
        studentPointsData[userId].lastUpdate = new Date().toLocaleString();
        await saveData(STUDENT_POINTS_KEY, studentPointsData);
        userPoints = studentPointsData[userId].points; // 更新本地积分
        message = `本次答题得分 **${score} 分** 已加入您的总积分！`;
      } else {
        // 非首次提交，不增加积分
        message = `您已提交过本套题，本次提交分数 **${score} 分** 不会增加积分。`;
      }

      // 关闭答题弹窗
      closeAnswerModal();

      // 显示得分详情弹窗
      showScoreDetailModal(score, currentPaper.totalPoints, scoreDetails, message, secondsElapsed);

      // *** 优化 2: 作答后保持登录状态 ***
      // 原有重置逻辑已移除，以便学生查看成绩后继续做题


      // 更新UI
      await calculateUserRank();
      await loadRankingList();
      await loadAndRenderPapers(); // 刷新套卷列表，更新“已作答”状态
      updatePrizeButtons();
    }

    // 显示得分详情弹窗
    function showScoreDetailModal(score, totalPoints, details, message, timeElapsed) {
      finalScoreDisplay.textContent = `${score}/${totalPoints}分`;
      scoreMessage.innerHTML = message; // 使用innerHTML来显示加粗信息
      scoreDetailList.innerHTML = '';

      // 格式化耗时
      const minutes = String(Math.floor(timeElapsed / 60)).padStart(2, '0');
      const seconds = String(timeElapsed % 60).padStart(2, '0');
      const timeDisplay = `${minutes}:${seconds}`;

      // 在详情列表顶部添加耗时信息
      scoreDetailList.innerHTML = `
        <div class="p-2 rounded-lg bg-blue-100 text-blue-700 font-bold">
          <i class="fa fa-hourglass-half mr-2"></i> 答题耗时：${timeDisplay}
        </div>
      `;

      details.forEach(item => {
        const detailItem = document.createElement('div');
        detailItem.className = `p-2 rounded-lg ${item.isCorrect ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
        detailItem.innerHTML = `
          <strong>第${item.questionNumber}题：</strong> 
          ${item.isCorrect ? '正确' : '错误'}
          <span class="ml-2"> | </span> 
          正确答案: ${item.correctAnswer}
        `;
        scoreDetailList.appendChild(detailItem);
      });

      scoreDetailModal.classList.remove('hidden');
      setTimeout(() => {
        scoreDetailContent.classList.remove('scale-95', 'opacity-0');
        scoreDetailContent.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    // 关闭得分详情弹窗
    function closeScoreDetailModal() {
      scoreDetailContent.classList.remove('scale-100', 'opacity-100');
      scoreDetailContent.classList.add('scale-95', 'opacity-0');

      setTimeout(() => {
        scoreDetailModal.classList.add('hidden');
      }, 300);
    }

    // 关闭答题弹窗
    function closeAnswerModal() {
      // 停止计时器（如果用户在未提交时关闭）
      stopTimer();

      // ... existing close logic ...
      answerCardModal.classList.add('hidden');
      modalContent.classList.remove('scale-100', 'opacity-100');
      modalContent.classList.add('scale-95', 'opacity-0');
    }

    // *** 图片预览功能 ***
    function showImagePreview(src) {
      if (!src) return;
      const modal = document.getElementById('imagePreviewModal');
      const img = document.getElementById('previewImage');

      img.src = src;
      modal.classList.remove('hidden');

      // 动画
      setTimeout(() => {
        modal.classList.remove('opacity-0');
        img.classList.remove('scale-95');
        img.classList.add('scale-100');
      }, 10);
    }

    function closeImagePreviewModal() {
      const modal = document.getElementById('imagePreviewModal');
      const img = document.getElementById('previewImage');

      modal.classList.add('opacity-0');
      img.classList.remove('scale-100');
      img.classList.add('scale-95');

      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }




    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', init);
  </script>
  <!-- 图片预览模态框 -->
  <div id="imagePreviewModal"
    class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 flex transition-opacity duration-300 opacity-0"
    onclick="closeImagePreviewModal()">
    <div class="relative w-full h-full p-4 flex items-center justify-center">
      <button class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 focus:outline-none z-50"
        onclick="closeImagePreviewModal()">&times;</button>
      <img id="previewImage" src=""
        class="max-w-full max-h-full object-contain rounded shadow-2xl transform transition-transform duration-300 scale-95"
        onclick="event.stopPropagation()">
    </div>
  </div>
</body>

</html>